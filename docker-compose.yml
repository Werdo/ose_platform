version: '3.8'

# ════════════════════════════════════════════════════════════════════════════
# OSE PLATFORM - Docker Compose Configuration (PRODUCTION)
# ════════════════════════════════════════════════════════════════════════════
#
# Servicios incluidos:
#   - mongodb: Base de datos principal
#   - backend: API FastAPI
#   - frontend: Portal React con Nginx
#
# Uso:
#   docker-compose up -d --build   # Iniciar todos los servicios
#   docker-compose down            # Detener todos los servicios
#   docker-compose logs -f         # Ver logs en tiempo real
#
# ════════════════════════════════════════════════════════════════════════════

services:
  # ──────────────────────────────────────────────────────────────────────────
  # MONGODB - Base de Datos Principal
  # ──────────────────────────────────────────────────────────────────────────
  mongodb:
    image: mongo:6.0
    container_name: ose_mongodb
    restart: unless-stopped

    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: oseplatform2025secure
      MONGO_INITDB_DATABASE: ose_platform

    ports:
      - "27018:27017"

    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb

    networks:
      - ose-network

    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/ose_platform --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

    command:
      - --auth
      - --bind_ip_all

  # ──────────────────────────────────────────────────────────────────────────
  # BACKEND - API FastAPI
  # ──────────────────────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend-new
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: 3.11

    container_name: ose_backend
    restart: unless-stopped

    env_file:
      - .env.production

    ports:
      - "8001:8000"

    volumes:
      - backend_logs:/var/log/ose
      - backend_uploads:/tmp/ose_uploads

    depends_on:
      mongodb:
        condition: service_healthy

    networks:
      - ose-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    command: uvicorn main:app --host 0.0.0.0 --port 8000

  # ──────────────────────────────────────────────────────────────────────────
  # FRONTEND - Portal React con Nginx
  # ──────────────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend-react/portal
      dockerfile: Dockerfile

    container_name: ose_frontend
    restart: unless-stopped

    ports:
      - "3001:80"

    depends_on:
      - backend

    networks:
      - ose-network

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

# ══════════════════════════════════════════════════════════════════════════
# VOLÚMENES - Persistencia de Datos
# ══════════════════════════════════════════════════════════════════════════
volumes:
  mongodb_data:
    driver: local
    name: ose_mongodb_data

  mongodb_config:
    driver: local
    name: ose_mongodb_config

  backend_logs:
    driver: local
    name: ose_backend_logs

  backend_uploads:
    driver: local
    name: ose_backend_uploads

# ══════════════════════════════════════════════════════════════════════════
# REDES - Comunicación entre Contenedores
# ══════════════════════════════════════════════════════════════════════════
networks:
  ose-network:
    driver: bridge
    name: ose-network
